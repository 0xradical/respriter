#!/usr/bin/env bash

source $1

count=1
until pg_isready -U $DATABASE_USER -h $DATABASE_HOST > /dev/null; do
  sleep 0.5;
  if [ $count -gt 20 ]; then
    echo -e "Database looks down.\nRun outside docker container:\n  make up-database "
    exit -1
  else
    count=$((count+1))
  fi;
done;

mkdir -p /app/db/seeds

echo "Building db/seeds/orphaned_profiles.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/orphaned_profiles.sql > /app/db/seeds/orphaned_profiles.csv

echo "Building db/seeds/providers.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/providers.sql         > /app/db/seeds/providers.csv

echo "Building db/seeds/courses.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/courses.sql           > /app/db/seeds/courses.csv

echo "Building db/seeds/user_accounts.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/user_accounts.sql     > /app/db/seeds/user_accounts.csv

echo "Building db/seeds/profiles.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/profiles.sql          > /app/db/seeds/profiles.csv

echo "Building db/seeds/oauth_accounts.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/oauth_accounts.sql    > /app/db/seeds/oauth_accounts.csv

echo "Building db/seeds/posts.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/posts.sql             > /app/db/seeds/posts.csv

echo "Building db/seeds/admin_accounts.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/admin_accounts.sql    > /app/db/seeds/admin_accounts.csv

echo "Building db/seeds/admin_profiles.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/admin_profiles.sql    > /app/db/seeds/admin_profiles.csv

echo "Building db/seeds/landing_pages.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/landing_pages.sql     > /app/db/seeds/landing_pages.csv

echo "Building db/seeds/images.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/images.sql            > /app/db/seeds/images.csv

echo "Building db/seeds/enrollments.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/enrollments.sql       > /app/db/seeds/enrollments.csv

echo "Building db/seeds/tracked_actions.csv ..."
PGPASSWORD=$DATABASE_PASSWORD psql -U $DATABASE_USER -h $DATABASE_HOST -p $DATABASE_PORT -d $DATABASE_DB -f /app/bin/sql/tracked_actions.sql   > /app/db/seeds/tracked_actions.csv

echo "Creating Seed File images/database/production_seed.sql"
/app/bin/create_database_seed_sql > /app/images/database/production_seed.sql

exit 0
