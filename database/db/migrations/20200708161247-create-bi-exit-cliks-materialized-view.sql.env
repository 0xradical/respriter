BEGIN;

CREATE MATERIALIZED VIEW bi.sales AS (
  SELECT
    DATE_TRUNC('day', tracked_actions.ext_click_date)::date as date,
    enrollments.tracking_data->>'utm_source' AS utm_source,
    enrollments.tracking_data->>'utm_medium' AS utm_medium,
    enrollments.tracking_data->>'utm_campaign' AS utm_campaign,
    tracked_actions.source AS payment_source,
    providers.name AS provider,
    enrollments.tracking_data->>'country' AS country,
    (courses.locale).language AS course_language,
    courses.category AS course_category,
    SUM(tracked_actions.earnings_amount) FILTER (WHERE tracked_actions.earnings_amount > 0) AS gross_revenue,
    SUM(tracked_actions.earnings_amount) FILTER (WHERE tracked_actions.earnings_amount < 0) AS refunded_amount,
    SUM(tracked_actions.earnings_amount) AS net_income,
    COUNT(tracked_actions.id) FILTER (WHERE tracked_actions.earnings_amount > 0) AS num_sales,
    COUNT(tracked_actions.id) FILTER (WHERE tracked_actions.earnings_amount < 0) AS num_refunds
  FROM
    app.tracked_actions
  INNER JOIN
    app.enrollments ON tracked_actions.enrollment_id = enrollments.id
  LEFT JOIN
    app.courses ON enrollments.course_id = courses.id
  INNER JOIN
    app.providers ON enrollments.provider_id = providers.id
  GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9
  ORDER BY 1
);

CREATE MATERIALIZED VIEW bi.exit_clicks AS (

  SELECT
    DATE_TRUNC('day', enrollments.created_at)::date as date,
    enrollments.tracking_data->>'utm_source' AS utm_source,
    enrollments.tracking_data->>'utm_medium' AS utm_medium,
    enrollments.tracking_data->>'utm_campaign' AS utm_campaign,
    providers.name AS provider,
    enrollments.tracking_data->>'country' AS country,
    (courses.locale).language AS course_language,
    courses.category AS course_category,
    COUNT(DISTINCT enrollments.tracking_cookies->>'id') AS unique_clicks
  FROM
    app.enrollments
  INNER JOIN
    app.courses ON enrollments.course_id = courses.id
  INNER JOIN
    app.providers ON courses.provider_id = providers.id
  GROUP BY 1, 2, 3, 4, 5, 6, 7, 8
   ORDER BY 1

 );

CREATE INDEX index_exit_clicks_on_date
ON bi.exit_clicks
USING btree (date);

CREATE INDEX index_sales_on_date
ON bi.sales
USING btree (date);


INSERT INTO public.schema_migrations (version) VALUES ('20200708161247');

COMMIT;
