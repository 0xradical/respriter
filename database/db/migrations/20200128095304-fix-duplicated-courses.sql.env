BEGIN;

CREATE OR REPLACE FUNCTION app.fill_sitemaps(
  _sitemaps app.sitemap[]
) RETURNS app.sitemap[] AS $$
  SELECT
    ARRAY_AGG(
      (
        COALESCE(sitemap.id,     public.uuid_generate_v4()),
        COALESCE(sitemap.status, 'unconfirmed'),
        sitemap.url,
        sitemap.type
      )::app.sitemap
    )
  FROM unnest(_sitemaps) AS sitemap
  WHERE
    sitemap.url IS NOT NULL
    AND char_length(sitemap.url) > 0
$$ LANGUAGE sql;

CREATE OR REPLACE FUNCTION app.new_sitemaps(
  _sitemaps app.sitemap[]
) RETURNS app.sitemap[] AS $$
  SELECT
    ARRAY_AGG(
      (
        COALESCE(sitemap.id, public.uuid_generate_v4()),
        'unconfirmed',
        sitemap.url,
        sitemap.type
      )::app.sitemap
    )
  FROM unnest(_sitemaps) AS sitemap
  WHERE
    sitemap.url IS NOT NULL
    AND char_length(sitemap.url) > 0
$$ LANGUAGE sql;

DROP FUNCTION triggers.md5_url();

DROP TRIGGER set_global_id FROM app.courses;
DROP TRIGGER set_global_id FROM app.preview_courses;

DROP INDEX app.index_courses_on_global_sequence;

CREATE UNIQUE INDEX index_courses_on_global_sequence
ON app.courses
USING btree (global_sequence);

DROP INDEX app.index_courses_on_slug;

CREATE UNIQUE INDEX index_courses_on_slug
ON app.courses
USING btree (slug)
WHERE published = true;
 
DROP INDEX app.index_courses_on_url_md5;

CREATE UNIQUE INDEX index_courses_on_url
ON app.courses
USING btree (url)
WHERE published = true;

INSERT INTO public.schema_migrations (version) VALUES ('20200128095304');

COMMIT;
