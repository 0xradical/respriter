BEGIN;

ALTER TABLE app.providers ADD COLUMN ignore_robots_noindex_rule_for app.locale[] DEFAULT '{}'::app.locale[];
ALTER TABLE app.providers ADD COLUMN ignore_robots_noindex_rule boolean DEFAULT false;

CREATE OR REPLACE VIEW api.providers AS
  SELECT *
  FROM app.providers AS provider
  WHERE
    (
      current_user = 'user'
      AND EXISTS (
        SELECT 1
        FROM app.provider_crawlers AS crawler
        WHERE
          crawler.status != 'deleted'
          AND crawler.provider_id = provider.id
          AND if_user_by_ids(crawler.user_account_ids, TRUE)
      )
    ) OR current_user = 'admin';

INSERT INTO public.schema_migrations (version) VALUES ('20200709184800');

COMMIT;
