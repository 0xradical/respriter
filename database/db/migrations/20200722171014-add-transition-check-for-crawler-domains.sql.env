BEGIN;

CREATE FUNCTION triggers.check_confirmation_status_transition() RETURNS trigger AS $$
BEGIN
  -- illegal transitions
  IF (OLD.authority_confirmation_status = 'confirmed' AND NEW.authority_confirmation_status <> 'confirmed') THEN
    RAISE EXCEPTION 'update failed' USING DETAIL = 'crawler_domain__illegal_transition', HINT = json_build_object('from', OLD.authority_confirmation_status, 'to', NEW.authority_confirmation_status);
  ELSE
    RETURN NEW;
  END IF;
END
$$ SECURITY DEFINER LANGUAGE plpgsql;

CREATE TRIGGER check_confirmation_status_transition
  BEFORE INSERT OR UPDATE
  ON app.crawler_domains
  FOR EACH ROW
    EXECUTE PROCEDURE triggers.check_confirmation_status_transition();


INSERT INTO public.schema_migrations (version) VALUES ('20200722171014');

COMMIT;
