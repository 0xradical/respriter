BEGIN;

CREATE TABLE app.course_reviews (
  id                uuid DEFAULT public.uuid_generate_v4() PRIMARY KEY,
  user_account_id   bigint REFERENCES app.user_accounts(id) ON DELETE CASCADE,
  tracked_action_id uuid REFERENCES app.tracked_actions(id) ON DELETE CASCADE,
  rating            numeric(1,0),
  completed         boolean,
  feedback          varchar,
  state             varchar NOT NULL DEFAULT 'pending',
  created_at        timestamptz  DEFAULT NOW() NOT NULL,
  updated_at        timestamptz  DEFAULT NOW() NOT NULL,
  CONSTRAINT rating__greater_than CHECK (rating >= 1),
  CONSTRAINT rating__less_than CHECK (rating <= 5),
  CONSTRAINT state__inclusion CHECK (state IN ('pending','accessed','submitted'))
);

CREATE TRIGGER track_updated_at
  BEFORE UPDATE
  ON app.course_reviews
  FOR EACH ROW
    EXECUTE PROCEDURE triggers.track_updated_at();

CREATE UNIQUE INDEX index_course_reviews_on_user_account_id_and_tracked_action_id
ON app.course_reviews
USING btree (user_account_id, tracked_action_id);

GRANT SELECT, INSERT, UPDATE, REFERENCES ON app.course_reviews TO "user";
GRANT SELECT, INSERT, UPDATE, DELETE, REFERENCES ON app.course_reviews TO "admin";

GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA app TO "user";

INSERT INTO public.schema_migrations (version) VALUES ('20191017152900');

COMMIT;
