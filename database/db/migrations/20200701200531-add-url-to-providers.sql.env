BEGIN;

ALTER TABLE app.providers ADD COLUMN url varchar;

CREATE OR REPLACE FUNCTION triggers.validate_url() RETURNS trigger AS $$
DECLARE
  _protocol text;
  _host     text;
BEGIN
  IF ( NEW.url IS NOT NULL ) THEN
    WITH parsed AS (
      SELECT alias, token FROM ts_debug(NEW.url)
    )
    SELECT (SELECT token FROM parsed WHERE alias = 'protocol') AS host,
            (SELECT token FROM parsed WHERE alias = 'host') AS url_path
      INTO _protocol, _host;

    IF (_protocol IS NULL) OR (_host IS NULL) THEN
      RAISE EXCEPTION 'url update failed' USING DETAIL = 'url__invalid_uri', HINT = json_build_object('value', NEW.website);
    END IF;
  END IF;

  RETURN NEW;
END;
$$ SECURITY DEFINER STABLE LANGUAGE plpgsql;

CREATE TRIGGER validate_url
  BEFORE INSERT OR UPDATE
  ON app.providers
  FOR EACH ROW
    EXECUTE PROCEDURE triggers.validate_url();

UPDATE app.providers SET url = 'https://www.udemy.com'                         WHERE id = 1; -- Udemy
UPDATE app.providers SET url = 'https://www.khanacademy.org'                   WHERE id = 2; -- Khan Academy
UPDATE app.providers SET url = 'https://www.coursera.org'                      WHERE id = 3; -- Coursera
UPDATE app.providers SET url = 'https://www.edx.org'                           WHERE id = 4; -- Edx
UPDATE app.providers SET url = 'https://www.udacity.com'                       WHERE id = 6; -- Udacity
UPDATE app.providers SET url = 'https://www.pluralsight.com'                   WHERE id = 8; -- Pluralsight
UPDATE app.providers SET url = 'https://www.estrategiaconcursos.com.br'        WHERE id = 9; -- Estrategia Concursos
UPDATE app.providers SET url = 'https://teamtreehouse.com'                     WHERE id = 10; -- Treehouse
UPDATE app.providers SET url = 'https://nptel.ac.in'                           WHERE id = 11; -- NPTEL
UPDATE app.providers SET url = 'https://www.babbel.com'                        WHERE id = 12; -- Babbel
UPDATE app.providers SET url = 'https://www.skillshare.com'                    WHERE id = 14; -- SkillShare
UPDATE app.providers SET url = 'https://www.futurelearn.com'                   WHERE id = 21; -- FutureLearn
UPDATE app.providers SET url = 'https://www.alura.com.br'                      WHERE id = 23; -- Alura
UPDATE app.providers SET url = 'https://masterclass.com'                       WHERE id = 26; -- Masterclass
UPDATE app.providers SET url = 'https://alison.com'                            WHERE id = 28; -- Alison
UPDATE app.providers SET url = 'https://www.eduk.com.br'                       WHERE id = 29; -- EduK
UPDATE app.providers SET url = 'https://www.edureka.co'                        WHERE id = 33; -- Edureka
UPDATE app.providers SET url = 'https://open.sap.com'                          WHERE id = 35; -- openSAP
UPDATE app.providers SET url = 'https://miriadax.net/home'                     WHERE id = 41; -- Miríadax
UPDATE app.providers SET url = 'https://mooc.fr'                               WHERE id = 43; -- France Université Numerique
UPDATE app.providers SET url = 'https://www.canvas.net'                        WHERE id = 51; -- Canvas Network
UPDATE app.providers SET url = 'https://www.novoed.com'                        WHERE id = 67; -- NovoEd
UPDATE app.providers SET url = 'https://www.kadenze.com'                       WHERE id = 70; -- Kadenze
UPDATE app.providers SET url = 'https://iversity.org'                          WHERE id = 74; -- iversity
UPDATE app.providers SET url = 'https://learn.eduopen.org'                     WHERE id = 83; -- EduOpen
UPDATE app.providers SET url = 'https://linkedin.com/learning'                 WHERE id = 87; -- Linkedin Learning
UPDATE app.providers SET url = 'https://openeducation.blackboard.com'          WHERE id = 111; -- Open Education by Blackboard
UPDATE app.providers SET url = 'http://www.federica.eu/c/'                     WHERE id = 112; -- Federica
UPDATE app.providers SET url = 'http://onlinecourse.olympic.org'               WHERE id = 122; -- University of Ottawa
UPDATE app.providers SET url = 'http://onlinecourse.olympic.org'               WHERE id = 123; -- University of Alabama
UPDATE app.providers SET url = 'https://apex.oracle.com'                       WHERE id = 124; -- Oracle
UPDATE app.providers SET url = 'http://telescopio.galileo.edu'                 WHERE id = 127; -- Galileo University
UPDATE app.providers SET url = 'https://mooc.cavilam.com'                      WHERE id = 510; -- CAVILAM - Alliance française
UPDATE app.providers SET url = 'https://stanford.edu/courses'                  WHERE id = 511; -- Stanford OpenEdx
UPDATE app.providers SET url = 'http://chaosbook.org'                          WHERE id = 513; -- Georgia Institute of Technology
UPDATE app.providers SET url = 'http://online.sgu.edu'                         WHERE id = 514; -- St. George's University
UPDATE app.providers SET url = 'http://academy.schooleducationgateway.eu'      WHERE id = 515; -- School Education Gateway - Teacher Academy
UPDATE app.providers SET url = 'https://www.acumenacademy.org'                 WHERE id = 516; -- +Acumen
UPDATE app.providers SET url = 'https://journalismcourses.org'                 WHERE id = 517; -- Knight Center for Journalism in the Americas
UPDATE app.providers SET url = 'https://courses.sdgacademy.org/learn'          WHERE id = 518; -- SDG Academy
UPDATE app.providers SET url = 'https://courses.buildacademy.com'              WHERE id = 519; -- Build Academy
UPDATE app.providers SET url = 'https://www.europeanschoolnetacademy.eu'       WHERE id = 520; -- European Schoolnet Academy
UPDATE app.providers SET url = 'https://www.esri.com/training'                 WHERE id = 521; -- Esri
UPDATE app.providers SET url = 'http://www.opencourseworld.de'                 WHERE id = 522; -- Microsoft Deutschland GmbH
UPDATE app.providers SET url = 'https://stanford.edu/courses'                  WHERE id = 523; -- Stanford University
UPDATE app.providers SET url = 'https://edulib.hec.ca'                         WHERE id = 524; -- HEC Montréal
UPDATE app.providers SET url = 'https://mylaw.net'                             WHERE id = 525; -- Ford Foundation
UPDATE app.providers SET url = 'http://www.chesscademy.com'                    WHERE id = 526; -- Chesscademy
UPDATE app.providers SET url = 'https://mooc.house'                            WHERE id = 528; -- mooc.house
UPDATE app.providers SET url = 'https://www.css.edu'                           WHERE id = 529; -- The College of St. Scholastica
UPDATE app.providers SET url = 'https://urjcx.urjc.es'                         WHERE id = 531; -- Universidad Rey Juan Carlos
UPDATE app.providers SET url = 'http://www.cs.ox.ac.uk'                        WHERE id = 535; -- University of Oxford
UPDATE app.providers SET url = 'https://www.leuphana.de'                       WHERE id = 537; -- Leuphana Universität Lüneburg
UPDATE app.providers SET url = 'https://fast.ai'                               WHERE id = 538; -- fast.ai
UPDATE app.providers SET url = 'https://www.iu.edu/'                           WHERE id = 539; -- Indiana University
UPDATE app.providers SET url = 'https://courses.philanthropyu.org'             WHERE id = 540; -- Philanthropy University
UPDATE app.providers SET url = 'http://www.nostis.org'                         WHERE id = 541; -- Nostis
UPDATE app.providers SET url = 'http://www.playwithyourmusic.org'              WHERE id = 542; -- Peer to Peer University
UPDATE app.providers SET url = 'http://www.nostis.org'                         WHERE id = 543; -- Palacký University, Olomouc
UPDATE app.providers SET url = 'http://plusacumen.org'                         WHERE id = 545; -- Accion Venture Lab
UPDATE app.providers SET url = 'http://www.procurementlearning.org'            WHERE id = 546; -- The World Bank
UPDATE app.providers SET url = 'http://university.adacore.com/courses'         WHERE id = 547; -- AdaCore University
UPDATE app.providers SET url = 'http://mooc.uji.es'                            WHERE id = 548; -- Universitat Jaume I
UPDATE app.providers SET url = 'http://www.cs.brown.edu'                       WHERE id = 549; -- Brown University
UPDATE app.providers SET url = 'https://academy.onsap.com'                     WHERE id = 550; -- OnSAP Academy
UPDATE app.providers SET url = 'https://extendstore.ucl.ac.uk'                 WHERE id = 553; -- University College London
UPDATE app.providers SET url = 'http://onlinecourse.olympic.org'               WHERE id = 556; -- IOC Athlete MOOC
UPDATE app.providers SET url = 'https://www.rwaq.org'                          WHERE id = 557; -- Rwaq (رواق)
UPDATE app.providers SET url = 'https://unccelearn.org'                        WHERE id = 558; -- United Nations
UPDATE app.providers SET url = 'http://foundations-of-science.zoology.msu.edu' WHERE id = 559; -- Michigan State University
UPDATE app.providers SET url = 'https://learn.moodle.net'                      WHERE id = 560; -- Moodle
UPDATE app.providers SET url = 'https://www.class2go.uwa.edu.au'               WHERE id = 561; -- University of Western Australia
UPDATE app.providers SET url = 'https://modernstates.org'                      WHERE id = 562; -- Modern States
UPDATE app.providers SET url = 'http://flexible.learn.edu'                     WHERE id = 563; -- The Graduate Institute, Geneva
UPDATE app.providers SET url = 'http://mooc.uva.nl/portal'                     WHERE id = 564; -- University of Amsterdam
UPDATE app.providers SET url = 'https://www.ulibre.ca'                         WHERE id = 565; -- Téluq
UPDATE app.providers SET url = 'https://kau.se'                                WHERE id = 566; -- Karlstad University
UPDATE app.providers SET url = 'https://lms.gacco.org'                         WHERE id = 567; -- gacco
UPDATE app.providers SET url = 'https://gwu.edu'                               WHERE id = 568; -- George Washington University
UPDATE app.providers SET url = 'http://digitalphotography.exposed'             WHERE id = 569; -- Harvard University
UPDATE app.providers SET url = 'http://mooc.audencia.com'                      WHERE id = 570; -- Audencia Nantes
UPDATE app.providers SET url = 'https://gestiondeprojet.pm'                    WHERE id = 571; -- École Centrale de Lille
UPDATE app.providers SET url = 'https://www.mit.edu'                           WHERE id = 572; -- Massachusetts Institute of Technology
UPDATE app.providers SET url = 'https://www.hackerone.com'                     WHERE id = 573; -- HackerOne
UPDATE app.providers SET url = 'https://courses.mooc.telecom-bretagne.eu'      WHERE id = 574; -- Institut Mines-Télécom
UPDATE app.providers SET url = 'http://work.caltech.edu'                       WHERE id = 575; -- California Institute of Technology
UPDATE app.providers SET url = 'http://m4d.colfinder.org'                      WHERE id = 576; -- Indian Institute of Technology Kanpur
UPDATE app.providers SET url = 'http://www.cambridgegcsecomputing.org'         WHERE id = 577; -- Cambridge University Press
UPDATE app.providers SET url = 'https://weka.waikato.ac.nz'                    WHERE id = 578; -- University of Waikato
UPDATE app.providers SET url = 'https://ethicon.edx.org'                       WHERE id = 579; -- Ethicon
UPDATE app.providers SET url = 'https://www.hightechhigh.org'                  WHERE id = 580; -- High Tech High
UPDATE app.providers SET url = 'http://www.wiziq.com'                          WHERE id = 581; -- WizIQ
UPDATE app.providers SET url = 'https://modernstates.org'                      WHERE id = 582; -- New York Institute of Technology
UPDATE app.providers SET url = 'https://modernstates.org'                      WHERE id = 583; -- Purdue University
UPDATE app.providers SET url = 'http://mooc.uji.es'                            WHERE id = 584; -- Fundacion para la Eficiencia Energética
UPDATE app.providers SET url = 'http://www.etsu.edu'                           WHERE id = 585; -- East Tennessee State University
UPDATE app.providers SET url = 'http://complexityacademy.io'                   WHERE id = 586; -- Complexity Academy
UPDATE app.providers SET url = 'http://moocs.sapiensmedicus.org'               WHERE id = 587; -- University of Guadalajara
UPDATE app.providers SET url = 'https://courses.nvidia.com'                    WHERE id = 588; -- Nvidia
UPDATE app.providers SET url = 'http://www.icrcproject.org'                    WHERE id = 589; -- International Committee of the Red Cross
UPDATE app.providers SET url = 'https://www.umass.edu'                         WHERE id = 590; -- University of Massachusetts Amherst
UPDATE app.providers SET url = 'http://psyasia.com'                            WHERE id = 591; -- PsyAsia International
UPDATE app.providers SET url = 'http://mvam.org'                               WHERE id = 592; -- Leiden University
UPDATE app.providers SET url = 'http://learning.climate-kic.org'               WHERE id = 593; -- Climate-KIC
UPDATE app.providers SET url = 'https://www.goethe-managing-the-arts.org'      WHERE id = 594; -- Goethe-Institut
UPDATE app.providers SET url = 'http://www.tu9.de'                             WHERE id = 595; -- TU9
UPDATE app.providers SET url = 'https://www.marinelittermooc.org'              WHERE id = 596; -- Open Universiteit Nederland
UPDATE app.providers SET url = 'https://forumacademy.weforum.org'              WHERE id = 597; -- World Economic Forum
UPDATE app.providers SET url = 'https://mylaw.net'                             WHERE id = 598; -- MyLaw
UPDATE app.providers SET url = 'http://go.distance.ncsu.edu'                   WHERE id = 599; -- North Carolina State University
UPDATE app.providers SET url = 'https://journalismcourses.org'                 WHERE id = 600; -- Google News Initiative
UPDATE app.providers SET url = 'https://www.ufm.edu'                           WHERE id = 601; -- Universidad Francisco Marroquín
UPDATE app.providers SET url = 'http://mooc.oil-and-gas.ifp-school.com'        WHERE id = 603; -- IFP School
UPDATE app.providers SET url = 'https://modernstates.org'                      WHERE id = 604; -- State University of New York
UPDATE app.providers SET url = 'http://courses.writinguniversity.org'          WHERE id = 608; -- University of Iowa
UPDATE app.providers SET url = 'https://modernstates.org'                      WHERE id = 609; -- American University
UPDATE app.providers SET url = 'https://course.ece.cmu.edu/~ece447'            WHERE id = 610; -- Carnegie Mellon University
UPDATE app.providers SET url = 'https://miriadax.net'                          WHERE id = 611; -- University of Extremadura
UPDATE app.providers SET url = 'https://mooc.marist.edu'                       WHERE id = 612; -- Marist College
UPDATE app.providers SET url = 'http://www.utas.edu.au'                        WHERE id = 613; -- University of Tasmania
UPDATE app.providers SET url = 'http://www.apu.apus.edu'                       WHERE id = 614; -- American Public University
UPDATE app.providers SET url = 'http://umb.sgleducation.com'                   WHERE id = 615; -- University of Massachusetts Boston
UPDATE app.providers SET url = 'https://poweringag.org/mooc'                   WHERE id = 616; -- TH Köln - University of Applied Sciences
UPDATE app.providers SET url = 'https://modernstates.org'                      WHERE id = 617; -- Johns Hopkins University
UPDATE app.providers SET url = 'https://online.dr-chuck.com'                   WHERE id = 618; -- University of Michigan
UPDATE app.providers SET url = 'https://platzi.com'                            WHERE id = 28807; -- Platzi

WITH t AS (
   SELECT app.providers.id AS provider_id, app.crawler_domains.domain AS domain
   FROM app.crawler_domains
   INNER JOIN app.provider_crawlers ON provider_crawlers.id = app.crawler_domains.provider_crawler_id
   INNER JOIN app.providers on app.providers.id = app.provider_crawlers.provider_id
)
UPDATE app.providers
SET url = 'https://' || t.domain
FROM t
WHERE app.providers.id = t.provider_id;

UPDATE app.providers SET afn_url_template = REPLACE(afn_url_template, '%{course_url}', '%{url}') WHERE afn_url_template IS NOT NULL;

INSERT INTO public.schema_migrations (version) VALUES ('20200701200531');

COMMIT;
