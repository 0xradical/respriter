BEGIN;

CREATE TABLE app.promo_accounts (
  id              bigserial PRIMARY KEY,
  user_account_id bigint    REFERENCES app.user_accounts(id) ON DELETE CASCADE,
  data            jsonb     DEFAULT '{}'::jsonb,
  created_at      timestamptz  DEFAULT NOW()       NOT NULL,
  updated_at      timestamptz  DEFAULT NOW()       NOT NULL
);

CREATE TRIGGER track_updated_at
  BEFORE UPDATE
  ON app.promo_accounts
  FOR EACH ROW
    EXECUTE PROCEDURE triggers.track_updated_at();

CREATE INDEX index_promo_accounts_on_user_account_id
ON app.promo_accounts
USING btree (user_account_id);

CREATE OR REPLACE VIEW api.promo_accounts AS
  SELECT
    id,
    COALESCE( if_admin(data),            if_user_by_id(id, data)            ) AS data,
    COALESCE( if_admin(user_account_id), if_user_by_id(id, user_account_id) ) AS user_account_id,
    created_at,
    updated_at
  FROM app.promo_accounts;

CREATE OR REPLACE FUNCTION triggers.api_promo_accounts_view_instead() RETURNS trigger AS $$
BEGIN
  UPDATE app.promo_accounts
  SET
    data = NEW.data
  WHERE
    id = OLD.id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER api_promo_accounts_view_instead
  INSTEAD OF UPDATE
  ON api.promo_accounts
  FOR EACH ROW
    EXECUTE PROCEDURE triggers.api_promo_accounts_view_instead();

GRANT SELECT, UPDATE, REFERENCES ON app.promo_accounts TO "user";
GRANT SELECT, UPDATE             ON api.promo_accounts TO "user";

GRANT SELECT, INSERT, UPDATE, DELETE, REFERENCES ON app.promo_accounts TO "admin";
GRANT SELECT,         UPDATE, DELETE ON api.promo_accounts TO "admin";

COMMIT;