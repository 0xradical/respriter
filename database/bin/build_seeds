#!/usr/bin/env bash

until pg_isready -U `./bin/parse_uri $POSTGRES_URL user` -h `./bin/parse_uri $POSTGRES_URL host`; do sleep 0.5; done;

query_paramsless_url=$(echo $POSTGRES_URL | cut -d\? -f1)

mkdir -p ./db/seeds

echo "Building db/seeds/orphaned_profiles.csv ..."
psql $query_paramsless_url -f ./bin/sql/orphaned_profiles.sql > ./db/seeds/orphaned_profiles.csv

echo "Building db/seeds/providers.csv ..."
psql $query_paramsless_url -f ./bin/sql/providers.sql         > ./db/seeds/providers.csv

echo "Building db/seeds/courses.csv ..."
psql $query_paramsless_url -f ./bin/sql/courses.sql           > ./db/seeds/courses.csv

echo "Building db/seeds/user_accounts.csv ..."
psql $query_paramsless_url -f ./bin/sql/user_accounts.sql     > ./db/seeds/user_accounts.csv

echo "Building db/seeds/profiles.csv ..."
psql $query_paramsless_url -f ./bin/sql/profiles.sql          > ./db/seeds/profiles.csv

echo "Building db/seeds/oauth_accounts.csv ..."
psql $query_paramsless_url -f ./bin/sql/oauth_accounts.sql    > ./db/seeds/oauth_accounts.csv

echo "Building db/seeds/posts.csv ..."
psql $query_paramsless_url -f ./bin/sql/posts.sql             > ./db/seeds/posts.csv

echo "Building db/seeds/admin_accounts.csv ..."
psql $query_paramsless_url -f ./bin/sql/admin_accounts.sql    > ./db/seeds/admin_accounts.csv

echo "Building db/seeds/admin_profiles.csv ..."
psql $query_paramsless_url -f ./bin/sql/admin_profiles.sql    > ./db/seeds/admin_profiles.csv

echo "Building db/seeds/landing_pages.csv ..."
psql $query_paramsless_url -f ./bin/sql/landing_pages.sql     > ./db/seeds/landing_pages.csv

echo "Building db/seeds/images.csv ..."
psql $query_paramsless_url -f ./bin/sql/images.sql            > ./db/seeds/images.csv

echo "Building db/seeds/enrollments.csv ..."
psql $query_paramsless_url -f ./bin/sql/enrollments.sql       > ./db/seeds/enrollments.csv

echo "Building db/seeds/tracked_actions.csv ..."
psql $query_paramsless_url -f ./bin/sql/tracked_actions.sql   > ./db/seeds/tracked_actions.csv

seeds_file="./db/seeds/prd_seed.sql"
echo "SET session_replication_role TO replica;" > $seeds_file

for file in $(ls ./db/seeds/*.csv); do
  base_filename=`basename $file`
  table_name=${base_filename%.csv}
  echo "COPY app.$table_name (`head -n 1 $file`) FROM '`echo $file | sed 's/\.\//\/database\//g'`' WITH CSV HEADER DELIMITER ',';" >> $seeds_file
done

for file in ./db/seeds/admin_accounts ./db/seeds/images ./db/seeds/landing_pages ./db/seeds/oauth_accounts ./db/seeds/user_accounts ; do
  base_filename=`basename $file`
  table_name=${base_filename%.csv}
  echo "SELECT setval('app.${table_name}_id_seq', MAX(id), true) FROM app.${table_name};" >> $seeds_file
done

echo "SET session_replication_role TO default;" >> $seeds_file
