BEGIN;

ALTER TABLE app.resources         ADD COLUMN extra             jsonb;
ALTER TABLE app.resources         ADD COLUMN last_execution_id uuid;

ALTER TABLE app.resource_versions ADD COLUMN extra             jsonb;
ALTER TABLE app.resource_versions ADD COLUMN last_execution_id uuid;

CREATE OR REPLACE FUNCTION triggers.resource_keeps_version()
RETURNS trigger AS $$
DECLARE
  new_dataset_sequence bigint;
BEGIN
  UPDATE app.datasets
  SET sequence = sequence + 1
  WHERE
    id = NEW.dataset_id
  RETURNING sequence
  INTO new_dataset_sequence;

  INSERT INTO app.resource_versions
    (
      dataset_sequence,
      sequence,
      resource_id,
      kind,
      schema_version,
      status,
      unique_id,
      content,
      relations,
      dataset_id,
      extra,
      last_execution_id,
      created_at,
      updated_at
    )
  VALUES
    (
      new_dataset_sequence,
      NEW.sequence,
      NEW.id,
      NEW.kind,
      NEW.schema_version,
      NEW.status,
      NEW.unique_id,
      NEW.content,
      NEW.relations,
      NEW.dataset_id,
      NEW.extra,
      NEW.last_execution_id,
      NEW.created_at,
      NEW.updated_at
    );

  RETURN NEW;
END;
$$ SECURITY DEFINER LANGUAGE plpgsql;

CREATE OR REPLACE VIEW api.resource_versions AS
  SELECT
    id,
    resource_id,
    dataset_sequence,
    dataset_id,
    sequence,
    status,
    created_at,
    updated_at,
    unique_id,
    kind,
    schema_version,
    content,
    relations,
    extra,
    last_execution_id
  FROM app.resource_versions
  WHERE
    if_dataset_id(dataset_id, TRUE);

CREATE OR REPLACE VIEW api.resources AS
  SELECT
    id,
    dataset_id,
    sequence,
    status,
    created_at,
    updated_at,
    unique_id,
    kind,
    schema_version,
    content,
    relations,
    extra,
    last_execution_id
  FROM app.resources
  WHERE
    if_dataset_id(dataset_id, TRUE);

INSERT INTO public.schema_migrations (version) VALUES ('20200211161612');

COMMIT;
