-- auto-generated, do not change!
-- run `make build-seeds` instead

WITH

next_template AS (
  INSERT INTO pipeline_templates (
    name,
    dataset_id,
    pipes
  ) SELECT
    'Babbel Course Pipeline',
    '<%= dataset_id %>',
    '[
      {
        "type":"Fetcher",
        "script": {
          "type":        "ruby",
          "source_code": <%= course_fetcher %>
        }
      },
      { "type": "ResourceCreator" }
    ]'
  RETURNING *
)

INSERT INTO pipeline_templates (
  name,
  data,
  bootstrap_script_type,
  bootstrap_script,
  success_script_type,
  success_script,
  dataset_id,
  pipes
) SELECT
  'Babbel Sitemap Pipeline',
  ('{"next_pipeline_template_id":"' || next_template.id || '","sitemap_url":"https://www.babbel.com/sitemap.xml","pricing_url":"https://home.babbel.com/prices"}')::jsonb,
  'sql',
  '
    WITH next_pipeline AS (
      INSERT INTO pipelines (
        label, pipeline_template_id
      ) VALUES (
        $1.label,
        ($1.data->>''next_pipeline_template_id'')::uuid
      )
      RETURNING *
    )

    UPDATE pipelines
    SET data = jsonb_set(pipelines.data, ''{next_pipeline_id}'', (''"'' || next_pipeline.id || ''"'')::jsonb)
    FROM next_pipeline
    WHERE pipelines.id = $1.id;

    INSERT INTO pipe_processes (pipeline_id, initial_accumulator) VALUES ($1.id, (''{"url":"'' || ($1.data->>''pricing_url'') || ''"}'')::jsonb);
    SELECT pipeline_call($1.id);
  ',
  'sql',
  'SELECT pipeline_call(($1.data->>''next_pipeline_id'')::uuid);',
  '<%= dataset_id %>',
  '[
    {
      "type": "Fetcher",
      "script": {
        "type":        "ruby",
        "source_code": <%= sitemap_price_fetcher %>
      }
    },
    {
      "type": "Fetcher",
      "gzip": true,
      "script": {
        "type":        "ruby",
        "source_code": <%= sitemap_fetcher %>
      }
    },
    {
      "type":"Demux",
      "script": {
        "type":        "ruby",
        "source_code": <%= sitemap_demux %>
      }
    }
  ]'
FROM next_template;

UPDATE pipeline_templates AS last_template
SET
  schedule_pipeline_template_id = first_template.id,
  schedule_interval             = '1 month'
FROM pipeline_templates AS first_template
WHERE
  first_template.name = 'Babbel Sitemap Pipeline' AND
  last_template.name  = 'Babbel Course Pipeline';
