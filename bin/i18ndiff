#!/usr/bin/env ruby

if ARGV.size < 2
  puts "Usage: i18ndiff file1 file2"
else
  file1, file2 = ARGV[0..1]

  def flatten(yaml, path = [])
    h = {}
    yaml.each_pair do |k,v|
      if !v.is_a?(Hash)
        h[(path.clone << k).join('.')] = v
      else
        h.merge!(flatten(v, path.clone << k ))
      end
    end
    h
  end

  require 'yaml'

  yaml1      = YAML.load_file(file1)
  yaml2      = YAML.load_file(file2)
  yaml1_lang = yaml1.keys.first
  yaml2_lang = yaml2.keys.first

  flatten1   = flatten(yaml1[yaml1_lang])
  flatten2   = flatten(yaml2[yaml2_lang])

  diff1    = flatten1.keys.map(&:to_sym) - flatten2.keys.map(&:to_sym)
  diff2    = flatten2.keys.map(&:to_sym) - flatten1.keys.map(&:to_sym)

  if diff1.size > 0 || diff2.size > 0
    if diff1.size > 0
      puts "Missing keys in #{file2}:\n"
      diff1.sort.each do |k|
        puts "* #{k}"
      end
    end

    if diff2.size > 0
      puts "Missing keys in #{file1}:\n"
      diff2.sort.each do |k|
        puts "* #{k}"
      end
    end
  else
    puts "No difference between the two files"
  end
end