#!/usr/bin/env ruby

class String
  def ansi(color)
    case color
      when :blue
       return "\033[34m#{self}\033[0m"
      when :red
        return "\033[31;1m#{self}\033[0m"
      when :yellow
        return "\033[33m#{self}\033[0m"
      when :green
        return "\033[32m#{self}\033[0m"
    end
  end
end

root_dir = "/app"

confirm = ''

banner = <<-TEXT
 .   ,
 |\_/|   ,--.
 (o.o)  / __ |
  `W'\ | /  `'
  ((  ||/
  ``( //      You journey starts here!
   ~~~'
TEXT

loop do
  puts banner.ansi(:blue)
  puts "This process will recreate your database and elasticsearch index from scratch. Any existing data will be lost! Proceed? [Y/n]".ansi(:yellow)
  confirm = STDIN.gets.chomp.downcase
  break if (confirm == 'y' || confirm == 'n')
  puts "unrecognized option: ".ansi(:yellow) + input
end

exit(1) if confirm == 'n'

puts "** linking node_modules **".ansi(:blue)
system 'rm -rf node_modules && ln -s ~/.config/yarn/global/node_modules /app/node_modules'

puts "** resetting database **".ansi(:blue)
system 'DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bundle exec rake db:drop db:create db:migrate'

puts "** resetting elasticsearch index **".ansi(:blue)
system 'bundle exec rake system:elasticsearch:reset_courses_index'
